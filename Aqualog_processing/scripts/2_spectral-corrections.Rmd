

More details on the protocols followed for building this PARAFAC model can be found in the [StaRdom package vingette](https://cran.r-project.org/web/packages/staRdom/vignettes/PARAFAC_analysis_of_EEM.html)


```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,  
                      warning = FALSE,
                      cache = FALSE, # only set to TRUE when doing final run
                      dev = "png", 
                      comment = '#>',
                      # fig.height = 10, 
                      # fig.width = 14,
                      #fig.path = "~/projects/Ch2_DOM/figures/2_spectral-corrections/"
                      fig.path = "../20230915_Goeckner-PGSdata/figures/"
                      )

knitr::knit_hooks$set(plot_par = function(before, options, envir) {
    if (before)
      par(mfrow = c(4, 4))   # figure grid
})

```

```{r library, include = FALSE, message = FALSE}
librarian::shelf(
  tidyr,
  plyr,
  dplyr,
#  staRdom,
  parallel, 
  doParallel,
  foreach,
  rlist,
  plot3D,
  data.table,
  knitr,
  quiet = TRUE)

options(scipen = 999)

#install.packages("staRdom")
```

```{r functions, include = FALSE}
source("./scripts/functions/plotting_parameters_and_functions.R")

source("./scripts/functions/spectral_corrections.R")

source("./scripts/functions/grid_size_adjustment.R")

source("./scripts/functions/format_aqua_data.R")

```


## 1. Start-Up and Data Prep



### 1. Load in EEMs and ABS Data

We will also generate and load in a metatable with dilution factors
which may or may not have been used during sample analysis. The current
function does not write the file path for absorbance data correctly, so
that function is also re-written prior to generating the metatable
template.

```{r load-abs-and-eems-data}

#What is this for??
cores <- parallel::detectCores(logical = FALSE)


#select project folder directory where abs and eem folders are stored
data_folder <- choose_directory() #select entire project folder

eem_folder <- paste(data_folder,"/eem",sep="") # selects eem folder
eem_list <- eem_read(eem_folder, import_function = eem_csv, recursive = T) # list of all eem files

absorbance_path <- paste(data_folder,"/abs",sep="") # select abs folder
absorbance <- absorbance_read(absorbance_path, recursive = T, cores = cores) # load csv or txt tables in folder

eem_metatemplate(eem_list, absorbance) %>%
 write.csv(file = "./projects/Bradford Streams/metatable_dilution_02132024.csv", row.names = FALSE)
##add DF now manually

```


#### 1. Import Meta-Table

```{r meta-import}

metatable <-
  "./projects/Bradford Streams/metatable_dilution_02132024.csv"

meta <-
  read.table(metatable,
    header = TRUE,
    sep = ",",
    dec = ".",
    row.names = 1)

```

#### 1. Remove Questionable Samples

Remove any samples with known issues such as poor data collection,
undiluted and oversaturated CCD, or just visually funky samples.

```{r remove-problem-samples}
# eem_list <-
#   eem_extract(
#     eem_list,
#     c("19MAY31",
#       "19MAY24",
#       "B2S20S20"),
#     ignore_case = TRUE)

# remove samples that exceeded CCD saturation. Some samples will have a diluted sample but a lot of the early ones do not
eem_list <-
  eem_extract(
    eem_list,
    c(
      "B1S7_HAT_2019Feb20",
      "B1S10_HOGUP_2019Aug14",
      "B1S11_HAT_2019Apr03" 
    ),
    ignore_case = TRUE
  )


```

### 1. Apply Corrections to ABS Data

Absorbance baseline correction corrects the instrumental baseline drift
in absorbance data by subtracting the mean of the absorbance at high
wavelengths (Li and Hur 2017). Default range is `c(680, 700)` but can be
changed (i.e., `c(650, 800)`)

```{r load-abs-data}
absorbance <- abs_blcor(absorbance, wlrange = c(680, 700))
```

### 1. Fix Emission Step Size

This adjusts the increments between emission wavelengths so that they
are uniform across the spectra. The m-correct and x-correct files do not
need to be applied as that has already been done by the software.

Try to match your wavelength range and step size increments to the range
and step sizes you collected the data at.

```{r fix-grid-size, message = FALSE, warning = FALSE, fig.show = 'hold'}

#this function is not changing all objects of a sample's list (needs to change x, em, and ex, only changes x)
eem_list <-
  adjust_fluorescence(
    eem_list,
    emission_range = c(246, 827),
    excitation_range = c(239, 800),
    emission_step = 2.5,
    excitation_step = 3
  )

#for now I am using the old approach here, but removing the emcor part and using Emily's ranges
eem_list <- eem_range(eem_list,ex = c(239,800), em = c(246,800))

#double checking the min and max here
min(eem_list[[1]][["ex"]]) #239
max(eem_list[[1]][["ex"]]) #800

```


### 1. Blank Subtraction

You may need to adjust the spectra range because blanks must be the same length as the samples they will be extracted from

```{r cut-range, echo = TRUE}
eem_list <-
  eem_range(eem_list, 
            ex = c(245, 600), 
            em = c(245, 650)
            )
```

```{r blank-subtraction}
# remove the blank scatter from sample scatter. if you have more than one blank, they will be averaged before removal. 
eem_list <- eem_remove_blank(eem_list)

# if removing a blank introduces some strongly negative values, a) double check your blank is good, if it is then b) try replacing negative values with 0
eem_list <-
  eem_interp(eem_list, type = 0, nonneg = TRUE)

# View EEMs plots
eem_overview_plot(eem_list, spp = 9, contour = TRUE)

```

```{r blank-threeD-plots, fig.show = 'hold'}
par(mfrow = c(3, 3), mar = c(1, 1, 2, 3))
eem_plot_3D(eem_list)

```

### 1. IFE Correction

```{r ife-correction, message = FALSE}
eem_list <-
  eem_ife_correction(
    data = eem_list,
    abs_data = absorbance,
    cuvl = 1,
    unit = "absorbance"
  )

# View EEMs plots
eem_overview_plot(eem_list, spp = 9, contour = TRUE)

```

```{r ife-threeD-plots, fig.show = 'hold'}
par(mfrow = c(3, 3), mar = c(1, 1, 2, 3))
eem_plot_3D(eem_list)

```

### 1. Raman Normalization

```{r raman-norm}
eem_list <- 
  eem_raman_normalisation2(eem_list, blank = "blank")

 eem_list_forReview <-
  eem_extract(
    eem_list,
    c("Pond18"),
    keep = TRUE,
    ignore_case = TRUE)

# View EEMs plots
eem_overview_plot(eem_list_forReview, spp = 9, contour = TRUE)

```

```{r raman-threeD-plots, fig.show = 'hold'}
par(mfrow = c(3, 3), mar = c(1, 1, 2, 3))
eem_plot_3D(eem_list)

```

### 1. Remove Blanks From Sample Set

```{r blank-sample-removal}
eem_list <-
  eem_extract(eem_list,
              c("nano", "miliq", "milliq", "mq", "blank"),
              ignore_case = TRUE)

absorbance <-
  dplyr::select(absorbance,
                -dplyr::matches("nano|miliq|milliq|mq|blank", ignore.case = TRUE))
```


#### 1. Remove Rayleigh Band 2 

```{r remove-raman-and-rayleigh-scatter}
remove_scatter <- c(FALSE, FALSE, FALSE, TRUE)
remove_scatter_width <- c(5, 5, 0, 20)

eem_list_rem <-
  eem_rem_scat(
    eem_list,
    remove_scatter = remove_scatter,
    remove_scatter_width = remove_scatter_width,
    interpolation = TRUE
  )

 eem_list_rem_forReview <-
  eem_extract(
    eem_list_rem,
    c("Pond18"),
    keep = TRUE,
    ignore_case = TRUE)
 
# Check Band Removal Widths
eem_overview_plot(eem_list_rem_forReview, spp = 9, contour = T)

```

#### 1. Remove Rayleigh Band 1 

```{r remove-scatter-asymmetrically-function, echo = FALSE}
source("./scripts/functions/eem_remove_scattering_nonsym.R")
```

```{r remove-scatter-asymmetrically}
eem_list_rem <-
  eem_remove_scattering_nonsym(
    eem_list_rem,
    type = "rayleigh",
    order = 1,
    width_above = 15,
    width_under = 50
  )

 eem_list_rem_forReview <-
  eem_extract(
    eem_list_rem,
    c("Pond18"),
    keep = TRUE,
    ignore_case = TRUE)
 
# Check Band Removal Widths
eem_overview_plot(eem_list_rem_forReview, spp = 9, contour = T)

```

```{r rem-scatter-threeD-plots, fig.show = 'hold'}
par(mfrow = c(2, 2), mar = c(1, 1, 2, 3))
eem_plot_3D(eem_list_rem)

```

### 1. Interpolate Scattering

```{r interp-EEMs, warning = FALSE}
# Interpolate EEMs for removed scatter bands
eem_list_done <- 
  eem_interp(
    eem_list_rem,
    cores = cores,
    type = 0,
    verbose = TRUE,
    nonneg = TRUE
  )
 eem_list_done_forReview <-
  eem_extract(
    eem_list_done,
    c("Pond18"),
    keep = TRUE,
    ignore_case = TRUE)
 
# View interpolated EEMs
eem_overview_plot(eem_list_done_forReview, spp = 9, contour = T)

```

```{r finished-threeD-plots, fig.show = 'hold'}
par(mfrow = c(3, 3), mar = c(1, 1, 2, 3))
eem_plot_3D(eem_list_done)

```

```{r clean-up-and-save}

#save objects for downstream analysis
saveRDS(object = c(eem_list_done,absorbance), file = paste0("./projects/20230915_Goeckner-PGSdata/processed-data/corrected_eems_abs_", Sys.Date(), ".rds" ))

```
